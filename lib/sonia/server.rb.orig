require "eventmachine"
require "em-websocket"
require "json"

module Sonia
  module Server
    extend self

    @@conf = {
      :twitter => {
        :title  => "Fuck yeah",
        :nitems => 10,
        :username => "ssuperawesom",
        :password => "tooobvious",
        :track => "obama"
      }
    }

    def run!
      EventMachine.run {
<<<<<<< HEAD
        @channel = EM::Channel.new
        @twitter = Sonia::Widgets::Twitter.new(ARGV[0], ARGV[1])
=======
>>>>>>> vicmargar/master

        @widgets = []

        @@conf.each_pair do | k, v |
          class_name = "Sonia::Widgets::#{k.to_s.capitalize}"
          @widgets << module_eval( class_name ).new( v )
        end

        EventMachine::WebSocket.start(:host => "0.0.0.0", :port => 8080, :debug => true) do |ws|
          ws.onopen    {
<<<<<<< HEAD
            @sid = @channel.subscribe { |msg| ws.send msg }
            @widgets.map { |widget| widget.subscribe!(ws) }
            # @widgets.each_with_index { |widget, i| widget.push "# connected!" }
            # TODO: Push configuration to the client here
            @channel.push '{"setup":{"widget":"Twitter","payload":{"a":1}}}'
=======
            @sids = @widgets.map { |widget| widget.subscribe!(ws) }
            setup = @widgets.map{ |widget| widget.setup }
            ws.send( { :setup => setup }.to_json )
>>>>>>> vicmargar/master
          }

          ws.onmessage { |msg|
            @widgets.each do |widget|
              widget.push "<#{@sids}>: #{msg}"
            end
          }

          ws.onclose {
            @widgets.each { |widget| widget.unsubscribe! }
            @channel.unsubscribe(@sid)
          }
        end

        puts "WebSocket Server running"
      }
    end
  end
end
